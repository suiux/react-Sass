<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Isometric Design</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Bootstrap icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" type="text/css" />
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <style>
            .lds-ripple {
                display: block;
                position: absolute;
                width: 80px;
                height: 80px;
                z-index: 9999;
                margin: auto;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
            }
            .lds-ripple div {
                position: absolute;
                border: 4px solid #fff;
                opacity: 1;
                border-radius: 50%;
                animation: lds-ripple 1s cubic-bezier(0, 0.2, 0.8, 1) infinite;
            }
            .lds-ripple div:nth-child(2) {
                animation-delay: -0.5s;
            }
            @keyframes lds-ripple {
                0% {
                top: 36px;
                left: 36px;
                width: 0;
                height: 0;
                opacity: 1;
                }
                100% {
                top: 0px;
                left: 0px;
                width: 72px;
                height: 72px;
                opacity: 0;
                }
            }
            
        </style>
    </head>
    <body>
        <!-- Navigation-->
        <nav class="navbar navbar-light bg-light static-top">
            <div class="container">
                <a class="navbar-brand" href="#!">Isometric</a>
                <a class="btn btn-primary" href="#signup">Sign Up</a>
            </div>
        </nav>

        <section id="3d-section">
            <div class="row justify-content-center" style="min-height: 100vh;background-color: #d6d6d6;">
                <div class="lds-ripple"><div></div><div></div></div>
                <div class="col-12"  id="model-3d" style="min-height: 100vh;">
                    
                </div>
            </div>
        </section>

        <div class="modal fade" id="infoBooth" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="infoBoothLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="infoBoothLabel">Modal title</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">&times;</button>
                </div>
                <div class="modal-body">
                  <center>
                    <img src="" alt="" id="boothImage" class="m-auto w-full">
                  </center>
                  <p>
                      Lorem ipsum dolor sit, amet consectetur adipisicing elit. Reiciendis debitis totam iure, aliquam dicta impedit, culpa nesciunt repellendus deserunt ut amet quas molestias nostrum cumque nemo aspernatur ea officia incidunt.
                  </p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  
                </div>
              </div>
            </div>
          </div>
        

     
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>


        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script type="module">
            import * as THREE from 'https://cdn.skypack.dev/three@v0.133.1';
            import { GLTFLoader } from 'https://cdn.skypack.dev/three@v0.133.1/examples/jsm/loaders/GLTFLoader.js';
            import { OrbitControls } from 'https://cdn.skypack.dev/three@v0.133.1/examples/jsm/controls/OrbitControls.js';
            import { RoomEnvironment } from 'https://cdn.skypack.dev/three@v0.133.1/examples/jsm/environments/RoomEnvironment.js';
           

            var myModal = new bootstrap.Modal(document.getElementById('infoBooth'))

            let renderer;
            let scene;
            let camera;
            let controls;
            let mesh;
            let mixer;
            let clock;
            let manager;
            var booths = [];



            function init() {
                
                scene = new THREE.Scene()
                createRenderer(scene);
                clock = new THREE.Clock()
                manager = new THREE.LoadingManager();
                manager.onLoad = function ( ) {

                    $("#3d-section").find(".lds-ripple").hide();
                
                };

                let aspect = $("#3d-section").width() / window.innerHeight
                let d = 1;
                var width  = $("#model-3d").width();
                var height  = window.innerHeight;
                //camera = new THREE.OrthographicCamera(-d * aspect, d * aspect, d, -d, 1, 2000)
                var zoom = 150;
                camera = new THREE.OrthographicCamera( width / - zoom,width / zoom, height / zoom, height / - zoom, 1, 1000 );
                
                camera.position.set(10, 10, 10)
                camera.lookAt(scene.position)
            
                controls = new OrbitControls( camera, renderer.domElement );
    
                scene.add(camera)
                controls.update();


                // const hemiLight = new THREE.HemisphereLight( 0xffffff, 0x444444 );
				// hemiLight.position.set( 0, 20, 0 );
				// scene.add( hemiLight );

				// const dirLight = new THREE.DirectionalLight( 0xffffff );
				// dirLight.position.set( 0, 2, 4 );
                // dirLight.intensity = 3;
				// // dirLight.castShadow = true;
				// // dirLight.shadow.camera.top = 2;
				// // dirLight.shadow.camera.bottom = - 2;
				// // dirLight.shadow.camera.left = - 2;
				// // dirLight.shadow.camera.right = 2;
				// // dirLight.shadow.camera.near = 0.1;
				// // dirLight.shadow.camera.far = 40;
				// scene.add( dirLight );

                // const dirLight2 = new THREE.DirectionalLight( 0xffffff );
                // dirLight2.position.set( 3, 3, 0 );
				// scene.add( dirLight2 );

      
            

                //createLights(scene)
                

                const loader = new GLTFLoader(manager);

                loader.load( 'model/isometric_base.gltf', function ( gltf ) {
                    var model = gltf.scene;
                    // model.traverse( function ( object ) {

                    //     if ( object.isMesh){
                    //         object.receiveShadow = true;
                    //     }
                            

                    // } );
                    scene.add(model);

                    loader.load( 'model/isometric_enter_popup.gltf', function ( booth ) {
                        booth.scene.position.set(-6,0,2)
                        booth.scene.traverse( function ( object ) {

                            if ( object.isMesh ){
                                // object.castShadow = true;
                                // object.cursor = 'pointer';
                                // object.on('mousedown', onDocumentMouseDown);
                                // object.on('mousemove', onDocumentMouseMove);
                            }
                                

                        } );
                        scene.add(booth.scene);
                        var animations = booth.animations;
                        mixer = new THREE.AnimationMixer( booth.scene );

                        var action = mixer.clipAction( animations[ 0 ] ); // access first animation clip
                        action.loop = THREE.LoopOnce;
                        action.clampWhenFinished = true;
                        action.play();
                        booths.push(booth.scene);
                        
                        booth.scene.boothData = {name:"Booth 1",image:"https://picsum.photos/seed/"+Math.floor(Math.random() * 100)+"/300/300"};

                        // const loader = new THREE.TextureLoader();

                        // loader.load(
                        //     booth.scene.boothData.image,
                        //     function ( texture ) {
                            
                        //         booth.scene.children[0].children[1].material.map =texture;
                        //         booth.scene.children[0].children[1].material.needsUpdate = true;
                                
                        //     },
                        //     // onProgress callback currently not supported
                        //     undefined,
                        //     // onError callback
                        //     function ( err ) {
                        //         console.error( 'An error happened.' );
                        //     }
                        // );

                        document.addEventListener( 'mousedown', onDocumentMouseDown, false );
                        document.addEventListener( 'mousemove', onDocumentMouseMove, false );

                    
                        
                    }, undefined, function ( error ) {

                        console.error( error );

                    } );

                    loader.load( 'model/isometric_enter_popup.gltf', function ( booth ) {
                        booth.scene.position.set(-5.5,0,-1)
                        scene.add(booth.scene);
                        var animations = booth.animations;
                        
                        var action = mixer.clipAction( animations[ 0 ],booth.scene); // access first animation clip
                        action.loop = THREE.LoopOnce;
                        action.clampWhenFinished = true;
                        action.play();
                    
                        booth.scene.boothData = {name:"Booth 2",image:"https://picsum.photos/seed/"+Math.floor(Math.random() * 100)+"/300/300"};

                        document.addEventListener( 'mousedown', onDocumentMouseDown, false );
                        document.addEventListener( 'mousemove', onDocumentMouseMove, false );
                        
                    }, undefined, function ( error ) {

                        console.error( error );

                    } );


                    loader.load( 'model/isometric_enter_popup.gltf', function ( booth ) {
                        booth.scene.position.set(-3.5,0,-1)
                        scene.add(booth.scene);
                        var animations = booth.animations;
                        
                        var action = mixer.clipAction( animations[ 0 ],booth.scene); // access first animation clip
                        action.loop = THREE.LoopOnce;
                        action.clampWhenFinished = true;
                        action.play();
                        booths.push(booth.scene);
                
                        booth.scene.boothData = {name:"Booth 3",image:"https://picsum.photos/seed/"+Math.floor(Math.random() * 100)+"/300/300"};

                        document.addEventListener( 'mousedown', onDocumentMouseDown, false );
                        document.addEventListener( 'mousemove', onDocumentMouseMove, false );
                        
                    }, undefined, function ( error ) {

                        console.error( error );

                    } );


                    loader.load( 'model/isometric_enter_popup.gltf', function ( booth ) {
                        booth.scene.position.set(-4,0,2)
                        scene.add(booth.scene);
                        var animations = booth.animations;
                        
                        var action = mixer.clipAction( animations[ 0 ],booth.scene); // access first animation clip
                        action.loop = THREE.LoopOnce;
                        action.clampWhenFinished = true;
                        action.play();
                        booths.push(booth.scene);
                        booth.scene.boothData = {name:"Booth 4",image:"https://picsum.photos/seed/"+Math.floor(Math.random() * 100)+"/300/300"};

                        document.addEventListener( 'mousedown', onDocumentMouseDown, false );
                        document.addEventListener( 'mousemove', onDocumentMouseMove, false );
                        
                    }, undefined, function ( error ) {

                        console.error( error );

                    } );
        

                }, undefined, function ( error ) {

                    console.error( error );

                } );

                

                
            
                

                animate();

                function onDocumentMouseDown( event ) 
                {
                    event.preventDefault();
                    var mouse = new THREE.Vector2();
                    mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
                    mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
                    var raycaster = new THREE.Raycaster();
                    raycaster.setFromCamera( mouse, camera );               
                    //var intersects = raycaster.intersectObjects( booths );   
                    
                    const intersects = raycaster.intersectObjects( scene.children );

                    var matched_marker = null;
                    if(intersects.length > 0)
                    {
                        // $('html,body').css('cursor','pointer');//mouse cursor change
                        for ( var i = 0;  intersects.length > 0 && i < intersects.length; i++)
                        {
                            if(intersects[0].object.parent.parent.boothData != undefined){
                                var bd = intersects[0].object.parent.parent.boothData;
                                $("#infoBoothLabel").html(bd.name);
                                $("#boothImage").attr('src',bd.image);
                                myModal.toggle();
                                break;
                            }
                                
                    
                        }
                    }
                    else {
                            //$('html,body').css('cursor','cursor');
                    }
                }
                
                function onDocumentMouseMove(event) {

                            var mouse = new THREE.Vector2();
                    mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
                    mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
                    var raycaster = new THREE.Raycaster();
                    raycaster.linePrecision = 0.1;
                    raycaster.setFromCamera( mouse, camera );
                    var intersects = raycaster.intersectObjects( scene.children  );
                    
                    if(intersects.length > 0) {
                        for ( var i = 0;  intersects.length > 0 && i < intersects.length; i++)
                        {
                            if(intersects[0].object.parent.parent.boothData != undefined){
                                $('html,body').css('cursor', 'pointer');
                            } else {
                                $('html,body').css('cursor', 'default');
                            }
                                
                    
                        }
                       
                    } else {
                        
                    }

                    }
            }

            function createRenderer(scene) {
                renderer = new THREE.WebGLRenderer({
                    antialias: true
                })
                renderer.outputEncoding = THREE.sRGBEncoding;
                // renderer.setClearColor( 0xfd6d6d6, 1);
                // renderer.shadowMap.enabled = true;
                const pmremGenerator = new THREE.PMREMGenerator( renderer );

            
                scene.background = new THREE.Color( 0xfd6d6d6 );
                scene.environment = pmremGenerator.fromScene( new RoomEnvironment(), 0.04 ).texture;

                renderer.setSize(window.innerWidth, window.innerHeight)
                document.getElementById('model-3d').appendChild(renderer.domElement)
            }



            function createLights(scene) {


                var light = new THREE.DirectionalLight(0xffffff,0.2)
                light.position.set(20, 0, 0);
                light.castShadow = true;
                scene.add(light)

                var light = new THREE.DirectionalLight(0xffffff,0.2)
                light.position.set(0, 20, 0);
                light.castShadow = true;
                scene.add(light)

                var light = new THREE.DirectionalLight(0xffffff,0.2)
                light.position.set(-20, 0, 0)
                light.castShadow = true;
                scene.add(light)

                var light = new THREE.DirectionalLight(0xffffff,0.2)
                light.position.set(0, -20, 0)
                light.castShadow = true;
                scene.add(light)


                var light = new THREE.DirectionalLight(0xffffff,0.5)
                light.position.set(0, 0, 20)
                light.castShadow = true;
                scene.add(light)

                var light = new THREE.DirectionalLight(0xffffff,0.5)
                light.position.set(0, 0, -20)
                light.castShadow = true;
                scene.add(light)

                

            }

            function animate(time) {
                requestAnimationFrame(animate)
                controls.update();
                var delta = clock.getDelta(); // clock is an instance of THREE.Clock
                if ( mixer ) mixer.update( delta );

                render()
            }

            function render() {
                renderer.render(scene, camera)
            }

            init();
        </script>
    </body>
</html>
